<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISRO Admin - Contact Messages</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/images/isro-logo.png">
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1><i class="fas fa-envelope"></i> Contact Messages</h1>
        </div>
        
        <table class="messages-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Sender</th>
                    <th>Subject</th>
                    <th>Message</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="messagesBody">
                <!-- Messages will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modal for viewing full message -->
    <div id="messageModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalSubject"></h2>
            <p><strong>From:</strong> <span id="modalSender"></span></p>
            <p><strong>Date:</strong> <span id="modalDate"></span></p>
            <div id="modalMessage" class="message-content"></div>
        </div>
    </div>

    <script>
        // Fetch and display messages
        async function loadMessages() {
            try {
                const response = await fetch('/api/messages');
                const messages = await response.json();
                
                const tableBody = document.getElementById('messagesBody');
                tableBody.innerHTML = '';
                
                messages.forEach(msg => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="timestamp">${new Date(msg.createdAt).toLocaleString()}</td>
                        <td>
                            <strong>${msg.name}</strong><br>
                            <small>${msg.email}</small>
                        </td>
                        <td>${msg.subject || 'No subject'}</td>
                        <td>
                            <div class="message-preview">${msg.message.substring(0, 50)}...</div>
                            <button class="expand-btn" onclick="showFullMessage('${msg._id}')">
                                <i class="fas fa-expand"></i> View
                            </button>
                        </td>
                        <td class="action-btns">
                            <button class="btn btn-view" onclick="viewMessage('${msg._id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-delete" onclick="deleteMessage('${msg._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // View full message in modal
        function viewMessage(id) {
            fetch(`/api/messages/${id}`)
                .then(res => res.json())
                .then(message => {
                    document.getElementById('modalSubject').textContent = message.subject || 'No subject';
                    document.getElementById('modalSender').textContent = `${message.name} <${message.email}>`;
                    document.getElementById('modalDate').textContent = new Date(message.createdAt).toLocaleString();
                    document.getElementById('modalMessage').textContent = message.message;
                    document.getElementById('messageModal').style.display = 'block';
                });
        }

        // Delete message
        function deleteMessage(id) {
            if (confirm('Are you sure you want to delete this message?')) {
                fetch(`/api/messages/${id}`, { method: 'DELETE' })
                    .then(() => loadMessages());
            }
        }

        // Close modal
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('messageModal').style.display = 'none';
        });

        // Load messages when page loads
        window.onload = loadMessages;
    </script>
</body>
</html>